---
title: "WR_v4 Het tests"
author: "FÃ¡tima S. Barreiro"
date: "October 20, 2020"
output: html_document
---


Load required libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(cowplot)
library(ggrepel)
library(reshape2)
library(dplyr)
library(tidyverse)
library(data.table)
require(scales)
library(ggpubr)
library(tidyr)
library(PairedData)
library(gridExtra)
```




Open metadata and genomic metrics table
```{r}
data = read.csv("WR_TableS1_v6.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```


### GW Het with GL2 <5x filtered sites and corrected by error rate at transversions estimates excluding the 4 samples of average depth of coverage <5x

First set the order of the time windows as they should appear on the plot
```{r}
data$time_window=factor(data$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
# plot het values per time window
gw_het = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(time_window, gw_het_GL2_5x_ErTv)) + 
  theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Genome-wide heterozygosity") +
  scale_y_continuous(labels = function(x) format(x, scientific = F), limits=c(0.00008, 0.00027))
  
  
# plot violin per group
gw_het = gw_het +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  

gw_het = gw_het + stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "greater"), label.y = c(0.00026, 0.00025), size=3, colour="gray20")   
#+ #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)

gw_het
```








#############################################################################

## RoH length and FRoH 

After parsing the output of BCFtools RoH in the server, the resulting values were copy-pasted to the metadata/data spreadsheet used here.
Now visualize and compare temporal groups in terms of FRoH and RoH length.

First set the order of the time windows as they should appear on the plot
```{r}
data$time_window=factor(data$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```



#### Plot FRoH per individual in time-window groups
```{r}
# plot het values per time window
fRoh = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461'),
       aes(time_window, Froh63_min10kb)) +
  
  # format scale in y axis
  scale_y_continuous(limits=c(0, 0.55), breaks=seq(0, 0.55, 0.1), labels=scales::number_format(accuracy = 0.01)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y=expression("F"["RoH"]))

  # plot violin per group
fRoh = fRoh +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  
  fRoh = fRoh + stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(0.5, 0.45), size=3, colour="gray20") 
  #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)
  

fRoh
```



#### Plot average RoH length per individual


Visualize average RoH length in the 10 largest scaffolds
```{r}
aveRoh = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461'),
       aes(time_window, Avg_RoH_len_63min10kb)) +
  
  scale_y_continuous(limits=c(50000, 720000), labels = function(x) format(x/1000000, digits=3, nsmall=2), breaks=seq(100000, 800000, 100000)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Average RoH length (Mbp)")

# plot violin per group
aveRoh = aveRoh +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  
# perform wilcox tests to compare groups
aveRoh = aveRoh + stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(450000, 700000), size=3, colour="gray20") #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)

aveRoh
  

```




#### Visualize maximum RoH length

Use the function written before to customize the y axis here too

```{r}
maxRoh = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461'),
       aes(time_window, Max_RoH_len_63min10kb)) +
  
  # customize the y axis scale
  scale_y_continuous(limits=c(100000, 16000000), labels = function(x) format(x/1000000, digits=3, nsmall=2), breaks=seq(1000000, 16000000, 2000000)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Maximum RoH length (Mbp)")


maxRoh = maxRoh +  
  # create boxplots
  geom_violin(aes(colour=time_window), fill="gray60", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4) +
  
  # run the wilcox tests to compare groups
  stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(14000000, 15000000), size=3, colour="gray20") #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)
  
maxRoh

```




### Make composite figure for genomic erosion stats

```{r}
erosion = ggarrange(gw_het + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
                    fRoh + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
                    aveRoh + theme(axis.text.x=element_text(size=10)), 
                    maxRoh + theme(axis.text.x=element_text(size=10)), 
                    nrow=2, ncol=2, align="v", labels=c( "A", "B" , "C", "D"))

erosion
```


```{r}
pdf("WR_v5_Fig4_GenomicErosion.pdf", useDingbats = F)
erosion
dev.off()
```



## Extra analyses

### Subsampling in NWR

Visualize differences between groups after removing samples from DRC in NWRpre, to rule out that population structure might be inflating genomic erosion patterns.

First set the order of the time windows as they should appear on the plot
```{r}
data$time_window=factor(data$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```


#### Genome-wide heterozygosity
```{r}
# plot het values per time window
gw_het_ss = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & country!="DRC"),
       aes(time_window, gw_het_GL2_5x_ErTv)) + theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Genome-wide heterozygosity") +
  
  # format scale in y axis
   scale_y_continuous(labels = function(x) format(x, scientific = F), limits=c(0.00008, 0.00026))


  # plot violin per group
gw_het_ss = gw_het_ss +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=2, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  
  gw_het_ss = gw_het_ss + 
    stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "greater"), size=3, colour="gray20", label.y=c(0.00024, 0.000225)) #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' & country!="DRC"), aes(label=sample_name), segment.size=.15, size=2)
  
gw_het_ss
```


#### Froh
```{r}
# plot Froh values per time window
fRohss = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' 
                            & country!="DRC"),
       aes(time_window, Froh63_min10kb)) +
  
  # format scale in y axis
  scale_y_continuous(limits=c(0, 0.55), breaks=seq(0, 0.55, 0.1), labels=scales::number_format(accuracy = 0.01)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y=expression("F"["RoH"]))

  # plot violin per group
fRohss = fRohss +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=2, alpha=.6) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  
  fRohss = fRohss + 
    stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(0.5, 0.45), size=3, colour="gray20") #+
  
#  geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' & country!="DRC"), aes(label=sample_name), segment.size=.15, size=2)
  
fRohss
```


#### Plot average RoH length per individual


Visualize average RoH length in the 10 largest scaffolds
```{r}
aveRohss = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' & country!="DRC"),
       aes(time_window, Avg_RoH_len_63min10kb)) +
  
  scale_y_continuous(limits=c(50000, 720000), labels = function(x) format(x/1000000, digits=3, nsmall=2), breaks=seq(100000, 800000, 100000)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Average RoH length (Mbp)")

# plot violin per group
aveRohss = aveRohss +  
  geom_violin(aes(colour=time_window), fill="gray70", lwd=.5, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.5) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
   # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4)
  
# perform wilcox tests to compare groups
aveRohss = aveRohss + stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(450000, 700000), size=3, colour="gray20") #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)

aveRohss
  

```



#### Visualize maximum RoH length

Use the function written before to customize the y axis here too

```{r}
maxRohss = ggplot(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' & country!="DRC"),
       aes(time_window, Max_RoH_len_63min10kb)) +
  
  # customize the y axis scale
  scale_y_continuous(limits=c(100000, 16000000), labels = function(x) format(x/1000000, digits=3, nsmall=2), breaks=seq(1000000, 16000000, 2000000)) +

# set up the panel
theme_bw() + theme(legend.position = "none") + labs(x=NULL, y="Maximum RoH length (Mbp)")


maxRohss = maxRohss +  
  # create boxplots
  geom_violin(aes(colour=time_window), fill="gray60", lwd=.5, alpha=.3) +
  
  # add scatter points per group
  geom_jitter(aes(colour=time_window), shape=17, position=position_jitter(0.11), cex=1.5, alpha=.5) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
   # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='gray30', width=.2, lwd=.4) +
  
  
  
  # run the wilcox tests to compare groups
  stat_compare_means(paired=F, method = "wilcox.test", comparisons = list(c("NWRpre", "NWRpost"), c("SWRpre", "SWRpost")), method.args = list(alternative = "less"), label.y=c(14000000, 15000000), size=3, colour="gray20") #+
  
  #geom_text_repel(data=subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01'), aes(label=sample_name), segment.size=.15, size=2)
  
maxRohss

```


Make composite figure for supplementary material

```{r}
erosionss = ggarrange(gw_het_ss + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
                    fRohss + theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()), 
                    aveRohss + theme(axis.text.x=element_text(size=10)), 
                    maxRohss + theme(axis.text.x=element_text(size=10)), 
                    nrow=2, ncol=2, align="v", labels=c( "A", "B" , "C", "D"))

erosionss
```


```{r}
pdf("WR_v5_FigS8_GenomicErosionSS.pdf",  useDingbats = F)
erosionss
dev.off()
```
















