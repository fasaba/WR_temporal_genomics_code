---
title: "WR Error Rates"
author: "FÃ¡tima S. Barreiro"
date: "October 8, 2020"
output: html_document
---

Load required libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(cowplot)
library(ggrepel)
library(reshape2)
library(dplyr)
library(tidyverse)
library(data.table)
require(scales)
library(ggpubr)
library(tidyr)
library(PairedData)
library(gridExtra)
```


Reading in file containing metadata and genomic diversity metrics 
```{r}
data = read.table("WR_ErrorRates_P9109_110best_BRout.Est.txt", header=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```


Reading in file containing metadata and genomic diversity metrics 
```{r}
metadata = read.csv("WR_TableS1_v5.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```



### Visualizing the error rates per sample

Bind the sample lab_IDs to the error rates dataframe so each row of error rates can be assigned to its corresponding sample
```{r}
# subset the error rate rows of interest
smalldata = data[1:52,]

# take from the metadata the relevant identification columns
IDs = as.data.frame(metadata$lab_ID)
colnames(IDs) = "ID"

samples = as.data.frame(metadata$sample_name)
colnames(samples) = "sample_name"

# bind the error rate subsetted data with the identifier columns
smalldata = cbind(smalldata, IDs, samples)
head(smalldata)
```


Melt the data to facilitate plotting
```{r}
smalldataM = reshape2::melt(smalldata)
head(smalldataM)
```


Visualizing the error rates (all types) per sample

```{r}
E = ggplot(smalldataM, aes(ID, value, fill=variable, colour=variable)) + geom_bar(position = position_dodge(0.6), stat = "identity", width=0.4, size=0.2) + theme_bw() +
  theme(axis.text.x=element_text(angle=80, hjust=1), legend.key.size= unit(4, "mm"), legend.title=element_blank()) +
  ylab("Error rate") + xlab("Sample name") + scale_x_discrete(labels = smalldataM$sample_name)

E
```


Save the plot
```{r eval=FALSE, include=FALSE}
pdf("WR_v4_ErrorRates.pdf", height=5, width=9, useDingbats = F)
E
dev.off()
```




### Correlations between error rates and estimates of heterozygosity

Parse the dataframe: add the heterozygosity estimates from the metadata. In this case I used the estimates with GL2 and filtering sites below 3x
```{r}
HET3x = metadata$gw_het_GL2_3x
HET5x = metadata$gw_het_GL2_5x

smalldataH = cbind(smalldata, HET3x, HET5x)
head(smalldataH)
```



Create a function to run and visualize linear regressions
```{r}

correlate_vars = function(dataframe, het_var, error_var, ID) {
  plot = ggscatter(dataframe, x = het_var, y = error_var, label = ID,
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson")
  return(plot)
  print(plot)
}

```


Use the function to visualise correlation plots of every error rate with the two Het estimates chosen
```{r}
correlate_vars(smalldataH, "HET3x", "TtoC", "ID")
correlate_vars(smalldataH, "HET3x", "CtoT", "ID")
correlate_vars(smalldataH, "HET3x", "GtoA", "ID")
correlate_vars(smalldataH, "HET3x", "AtoG", "ID")
correlate_vars(smalldataH, "HET3x", "GtoT", "ID")
correlate_vars(smalldataH, "HET3x", "TtoG", "ID")
correlate_vars(smalldataH, "HET3x", "AtoT", "ID")
correlate_vars(smalldataH, "HET3x", "TtoA", "ID")
correlate_vars(smalldataH, "HET3x", "GtoC", "ID")
correlate_vars(smalldataH, "HET3x", "CtoG", "ID")
correlate_vars(smalldataH, "HET3x", "AtoC", "ID")
correlate_vars(smalldataH, "HET3x", "CtoA", "ID")

```



```{r}
correlate_vars(smalldataH, "HET5x", "TtoC", "ID")
correlate_vars(smalldataH, "HET5x", "CtoT", "ID")
correlate_vars(smalldataH, "HET5x", "GtoA", "ID")
correlate_vars(smalldataH, "HET5x", "AtoG", "ID")
correlate_vars(smalldataH, "HET5x", "GtoT", "ID")
correlate_vars(smalldataH, "HET5x", "TtoG", "ID")
correlate_vars(smalldataH, "HET5x", "AtoT", "ID")
correlate_vars(smalldataH, "HET5x", "TtoA", "ID")
correlate_vars(smalldataH, "HET5x", "GtoC", "ID")
correlate_vars(smalldataH, "HET5x", "CtoG", "ID")
correlate_vars(smalldataH, "HET5x", "AtoC", "ID")
correlate_vars(smalldataH, "HET5x", "CtoA", "ID")

```




The following error rates correlate significantly with Het estimates:
G-to-T
T-to-G (marginally)
A-to-T
T-to-A
A-to-C (marginally)
C-to-A

This is probably due to the samples in the SRR which show higher error rates at transversion sites than the remaining batches.

On the other hand, Het estimates with 5x filtering seem to correlate with transition error rates too, however this seems to be driven by the low depth of coverage samples that will be excluded (TG0450, TG0451, TG0456, TGF01).



### Calculate a transversion composite error rate with which to correct the Het estimates to buffer the effect of the SRR batch

Calculate a composite error rate at Tv sites by summing up all error rates per row
```{r}
smalldata %>% 
  dplyr::select(GtoT, TtoG, AtoT, TtoA, AtoC, CtoA) %>% 
  rowSums(na.rm=TRUE) -> smalldata$ErTv

head(smalldata)
```


Save these error rates (single and composite) as a separate file 
```{r}
write.table(smalldata, file="WR_Errors_ErTv.csv", row.names=F, col.names=T, sep=",")
```






### Calculate the corrected het by operating with the composite error rate and the het estimate

```{r}
smalldataHc = cbind(smalldataH, smalldata$ErTv)
head(smalldataHc)

# subtract from the Het estimate the excess driven by transversion error rates
smalldataHc = smalldataHc %>% 
  mutate(HET3x_corrected = HET3x-(HET3x*smalldata$ErTv), HET5x_corrected = HET5x-(HET5x*smalldata$ErTv) )

```



Visualise the new het estimates
```{r}
tinydataHc = smalldataHc %>%
  dplyr::select(ID, HET3x, HET5x, HET3x_corrected, HET5x_corrected)

tinydataHc = reshape2::melt(tinydataHc)
```



```{r}
P = ggplot(tinydataHc, aes(ID, value, colour=variable)) + geom_point() + theme_bw() +
  theme(axis.text.x=element_text(angle=80, hjust=1), legend.title = element_blank(), legend.position = "top")
  
P
```





















