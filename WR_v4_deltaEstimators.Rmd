---
title: "WR_v4_deltaEstimators"
author: "FÃ¡tima S. Barreiro"
date: "November 17, 2020"
output: html_document
---

Load required libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(cowplot)
library(ggrepel)
library(reshape2)
library(dplyr)
library(tidyverse)
library(data.table)
require(scales)
library(ggpubr)
library(tidyr)
library(PairedData)
library(gridExtra)
```

Open metadata and genomic metrics table
```{r}
data = read.csv("WR_TableS1_v6.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```




## GW Het

Remove the 4 samples of depth <5x for comparisons of genome-wide het
```{r}
datassHet = subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01')
```

Split the filtered data frame into the 4 time windows
```{r}
NWRpreH = datassHet[datassHet$time_window == "NWRpre",]
NWRpostH = datassHet[datassHet$time_window == "NWRpost",]
SWRpreH = datassHet[datassHet$time_window == "SWRpre",]
SWRpostH = datassHet[datassHet$time_window == "SWRpost",]

```


Check the number of inviduals in each group
```{r}
dim(NWRpreH)
dim(NWRpostH)
dim(SWRpreH)
dim(SWRpostH)

```

### Median comparisons for GW Het

#### NWR
```{r}
wilcox.test(NWRpreH$gw_het_GL2_5x_ErTv, NWRpostH$gw_het_GL2_5x_ErTv, paired=F, alternative = "greater")
```

#### SWR
```{r}
wilcox.test(SWRpreH$gw_het_GL2_5x_ErTv, SWRpostH$gw_het_GL2_5x_ErTv, paired=F, alternative = "greater")
```

### Delta estimators for GW Het
Delta estimators
```{r}
datassHet$time_window=factor(datassHet$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassHet %>%
  group_by(time_window) %>%
  #summarize(min=min(gw_het_GL2_5x_ErTv), max=max(gw_het_GL2_5x_ErTv), median=median(gw_het_GL2_5x_ErTv))
  summarize(median=median(gw_het_GL2_5x_ErTv))
  
```



###################################################

## RoH length and FRoH

Remove the samples that either: have depth <5x (4 samples) and/or have error rates >1% (4 extra samples) for comparisons of RoH and Froh
```{r}
datassF = subset(data, lab_ID!='mwr_TG0450' & lab_ID!='mwr_TG0451' & lab_ID!='mwr_TG0456' & lab_ID!='mwr_TGF01' & lab_ID!='mwr_TG0452' & lab_ID!='mwr_TG0461' & lab_ID!='mwr_TGF02' & lab_ID!='mwr_TGF04')
dim(datassF)
```

Split the filtered data frame into time windows
```{r}
NWRpreF = datassF[datassF$time_window == "NWRpre",]
NWRpostF = datassF[datassF$time_window == "NWRpost",]
SWRpreF = datassF[datassF$time_window == "SWRpre",]
SWRpostF = datassF[datassF$time_window == "SWRpost",]

```

Check number of individuals in each group
```{r}
dim(NWRpreF)
dim(NWRpostF)
dim(SWRpreF)
dim(SWRpostF)

```


### Median comparisons for FRoH

#### NWR
Group comparison
```{r}
wilcox.test(NWRpreF$Froh_100kbmin, NWRpostF$Froh_100kbmin, paired=F, alternative = "less")
```

#### SWR
```{r}
wilcox.test(SWRpreF$Froh_100kbmin, SWRpostF$Froh_100kbmin, paired=F, alternative = "less")
```



### Delta estimators for FRoH
Delta estimators
```{r}
datassF$time_window=factor(datassF$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassF %>%
  group_by(time_window) %>%
  summarize(min=min(Froh_100kbmin), max=max(Froh_100kbmin), median=median(Froh_100kbmin))
```


### Median comparisons for average RoH length

#### NWR
Group comparison
```{r}
wilcox.test(NWRpreF$avg_roh_len_100kbmin, NWRpostF$avg_roh_len_100kbmin, paired=F, alternative = "less")
```

#### SWR
```{r}
wilcox.test(SWRpreF$avg_roh_len_100kbmin, SWRpostF$avg_roh_len_100kbmin, paired=F, alternative = "less")
```



### Delta estimators for average roh length
Delta estimators
```{r}
datassF$time_window=factor(datassF$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassF %>%
  group_by(time_window) %>%
  summarize(min=min(avg_roh_len_100kbmin), max=max(avg_roh_len_100kbmin), median=median(avg_roh_len_100kbmin))
```



### Median comparisons for maximum RoH length

#### NWR
Group comparison
```{r}
wilcox.test(NWRpreF$max_roh_len_100kbmin, NWRpostF$max_roh_len_100kbmin, paired=F, alternative = "less")
```

#### SWR
```{r}
wilcox.test(SWRpreF$max_roh_len_100kbmin, SWRpostF$max_roh_len_100kbmin, paired=F, alternative = "less")
```



### Delta estimators for max length of RoH
Delta estimators
```{r}
datassF$time_window=factor(datassF$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassF %>%
  group_by(time_window) %>%
  summarize(min=min(max_roh_len_100kbmin), max=max(max_roh_len_100kbmin), median=median(max_roh_len_100kbmin))
```





#################################################################################################################################
#################################################################################################################################



## Subsampling NWRpre to rule out the effect of population structure in genomic erosion

### Genome-wide heterozygosity
```{r}
datassHetnoDRC = subset(datassHet, country!="DRC")
dim(datassHetnoDRC)

```

Split the filtered data frame into the 4 time windows
```{r}
NWRpreHnoDRC = datassHetnoDRC[datassHetnoDRC$time_window == "NWRpre",]
NWRpostHnoDRC = datassHetnoDRC[datassHetnoDRC$time_window == "NWRpost",]
SWRpreHnoDRC = datassHetnoDRC[datassHetnoDRC$time_window == "SWRpre",]
SWRpostHnoDRC = datassHetnoDRC[datassHetnoDRC$time_window == "SWRpost",]

```

Check number of individuals in each group
```{r}
dim(NWRpreHnoDRC)
dim(NWRpostHnoDRC)
dim(SWRpreHnoDRC)
dim(SWRpostHnoDRC)

```


#### NWR
```{r}
wilcox.test(NWRpreHnoDRC$gw_het_GL2_5x_ErTv, NWRpostHnoDRC$gw_het_GL2_5x_ErTv, paired=F, alternative = "greater")
```


### Delta estimators for GW Het
Delta estimators
```{r}
datassHetnoDRC$time_window=factor(datassHetnoDRC$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassHetnoDRC %>%
  group_by(time_window) %>%
  #summarize(min=min(gw_het_GL2_5x_ErTv), max=max(gw_het_GL2_5x_ErTv), median=median(gw_het_GL2_5x_ErTv))
  summarize(median=median(gw_het_GL2_5x_ErTv))
  
```

Calculate the delta estimator for subsampled NWR comparison
```{r}
# With the values from the table above, do median post-bottleneck value minus median pre-bottleneck value, divided by the median pre-bottleneck value
(0.000187790-0.000205635)/0.000205635

# the result is the decrease in GW Het between NWRpre and post (excluding DRC)
```



#### Froh
```{r}
datassFnoDRC = subset(datassF, country!="DRC")
dim(datassFnoDRC)
```


Split the filtered data frame into time windows
```{r}
NWRpreFnoDRC = datassFnoDRC[datassFnoDRC$time_window == "NWRpre",]
NWRpostFnoDRC = datassFnoDRC[datassFnoDRC$time_window == "NWRpost",]
SWRpreFnoDRC = datassFnoDRC[datassFnoDRC$time_window == "SWRpre",]
SWRpostFnoDRC = datassFnoDRC[datassFnoDRC$time_window == "SWRpost",]

```

```{r}
dim(NWRpreFnoDRC)
dim(NWRpostFnoDRC)
dim(SWRpreFnoDRC)
dim(SWRpostFnoDRC)

```


### Median comparisons for FRoH

#### NWR
Group comparison
```{r}
wilcox.test(NWRpreFnoDRC$Froh_100kbmin, NWRpostFnoDRC$Froh_100kbmin, paired=F, alternative = "less")
```

### Delta estimators for FRoH
Delta estimators
```{r}
datassFnoDRC$time_window=factor(datassFnoDRC$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassFnoDRC %>%
  group_by(time_window) %>%
  summarize(min=min(Froh_100kbmin), max=max(Froh_100kbmin), median=median(Froh_100kbmin))
```


Calculate the delta estimator for subsampled NWR comparison
```{r}
# With the values from the table above, do median post-bottleneck value minus median pre-bottleneck value, divided by the median pre-bottleneck value
(0.4023980-0.3843370)/0.3843370

# the result is the increase in Froh between NWRpre and post (excluding DRC)
```



### Median comparisons for AVERAGE RoH length in subsampled NWR comparisons


#### Group comparison
```{r}
wilcox.test(NWRpreFnoDRC$avg_roh_len_100kbmin, NWRpostFnoDRC$avg_roh_len_100kbmin, paired=F, alternative = "less")
```

#### Delta estimators

```{r}
datassFnoDRC$time_window=factor(datassFnoDRC$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassFnoDRC %>%
  group_by(time_window) %>%
  summarize(min=min(avg_roh_len_100kbmin), max=max(avg_roh_len_100kbmin), median=median(avg_roh_len_100kbmin))
```





### Median comparisons for MAXIMUM RoH length in subsampled NWR comparisons


#### Group comparison
```{r}
wilcox.test(NWRpreFnoDRC$max_roh_len_100kbmin, NWRpostFnoDRC$max_roh_len_100kbmin, paired=F, alternative = "less")
```

#### Delta estimators

```{r}
datassFnoDRC$time_window=factor(datassFnoDRC$time_window, levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
datassFnoDRC %>%
  group_by(time_window) %>%
  summarize(min=min(max_roh_len_100kbmin), max=max(max_roh_len_100kbmin), median=median(max_roh_len_100kbmin))
```








