---
title: "WR_v4_PCAs"
author: "FÃ¡tima S. Barreiro"
date: "October 29, 2020"
output: html_document
---

Load required libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(dplyr)
library(tidyverse)
library(ggpubr)
library(tidyr)
library(cowplot)
library(ggrepel)
```


```{r}
# load metadata
md = read.csv("WR_TableS1_v5.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")

# make a subset where related inds (1 from each pair) has been removed
md_unrel = md[md$sample_name != 'CD-un.1' & md$sample_name != 'un1856.1' & md$sample_name != 'ZA1842.1', ]
```


## PCA of all 4 groups, entire unrelated dataset (49 samples)

Open the covariance matrix and do the eigen decomposition into vectors and values
```{r}
# prepare covariance matrix
D <-"WR.49I.above13Mb_NoSexChr_NonMaskedRegions_GL2_unrelated.tv.cov"
m <- as.matrix(read.table(D))

# run the eigen decomposition
e <- eigen(m)

# calculate the eigenvalues
eval = e$values/sum(e$values)
```


Select PCs to plot and bind them to metadata
```{r}
# PC1 and PC2
pcs <- as.data.frame(e$vectors[,1:3])
colnames(pcs) = c("PC1", "PC2", "PC3")

# Extract relevant columns from metadata for plotting
mini_md = as.data.frame(md_unrel %>% select(time_window, country))

evec <- cbind(mini_md, pcs)
head(evec)
```

Make a composite column for the legend
```{r}
evec$window_country <- paste(evec$time_window, evec$country, sep = " ")
head(evec)
```





Set the right order of factors for the legend


```{r}
evec$window_country=factor(evec$window_country,levels=c("NWRpre DRC", "NWRpre Sudan", "NWRpre Uganda", "NWRpost South Sudan", "NWRpost Sudan", "NWRpost Uganda", "SWRpre South Africa", "SWRpre Namibia", "SWRpost unknown", "SWRpost South Africa", "SWRpost captive"))
```


Visualize PCs with legend per subspecies, time window and country of origin
```{r}
## PC1 vs PC2
A = ggplot(evec, aes(x=PC1, y=PC2)) +
  
  # draw intercept lines
  geom_vline(xintercept=0, colour="gray", linetype = "longdash")+
  geom_hline(yintercept=0, colour="gray", linetype = "longdash")+
  
  # plot data points (2 legend alternatives)
  geom_point(aes(colour = window_country, shape = window_country), alpha=.8, size=4) + 
  
  # assign colors and shapes
  scale_colour_manual(values=c("gold3", "gold3", "gold3", "darkorange", "darkorange", "darkorange", "royalblue4", "royalblue4", "steelblue3", "steelblue3" , "steelblue3" )) +
  #scale_shape_manual(values=c(15, 17, 4, 7, 17, 4, 16, 12, 13, 16, 8)) +
  scale_shape_manual(values=c(15, 17, 8, 15, 17, 8, 16, 17, 17, 16, 8)) +
  
  # labels, titles, background, etc.
  xlab(paste0("PC1 (", round(eval[1]*100, 2), "%)"))+
  ylab(paste0("PC2 (", round(eval[2]*100, 2), "%)"))+
  
  theme(panel.background = element_rect(fill='white', colour='black'), axis.text.x = element_text(colour='black'), axis.text.y = element_text(colour='black'), 
        strip.background = element_rect(size=.2, colour="black", fill ="#FFA5004D"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title=element_text(size=0), legend.key=element_rect(fill="white", colour="white"), axis.title=element_text(size=10), legend.text=element_text(size=8), legend.key.size=unit(.8, "cm"),
        legend.position = "bottom", legend.margin=margin(0,0,0,0), legend.box.margin=margin(-10,-10,-10,-10))
  
  #guides(colour=guide_legend(nrow=2, ncol=6))

A
```



## PCs 2 vs 3
```{r}
evec$time_window=factor(evec$time_window,levels=c("NWRpre","NWRpost","SWRpre", "SWRpost"))
```

```{r}
## PC2 vs PC3
B = ggplot(evec, aes(x=PC2, y=PC3)) +
  
  # draw intercept lines
  geom_vline(xintercept=0, colour="gray", linetype = "longdash")+
  geom_hline(yintercept=0, colour="gray", linetype = "longdash")+
  
  # plot data points (2 legend alternatives)
  geom_point(aes(colour = time_window, shape = time_window), alpha=.8, size=4) + 
  
  # assign colors and shapes
  scale_colour_manual(values=c("gold3", "darkorange", "royalblue4", "steelblue3")) +
  scale_shape_manual(values=c(15, 16, 17, 8)) +
  
  # labels, titles, background, etc.
  xlab(paste0("PC2 (", round(eval[2]*100, 2), "%)"))+
  ylab(paste0("PC3 (", round(eval[3]*100, 2), "%)"))+
  
  theme(panel.background = element_rect(fill='white', colour='black'), axis.text.x = element_text(colour='black'), axis.text.y = element_text(colour='black'), 
        strip.background = element_rect(size=.2, colour="black", fill ="#FFA5004D"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title=element_text(size=0), legend.key=element_rect(fill="white", colour="white"), axis.title=element_text(size=10), legend.text=element_text(size=10), legend.key.size=unit(.8, "cm"), 
        legend.position = "top", legend.margin=margin(0,0,0,0), legend.box.margin=margin(0,-10,-10,-10), plot.margin=unit(c(0,0,0,1), "cm"))

B
```






########################################################################################################

## PCA's per subspecies


### NWR

Open the covariance matrices of NWR or SWR and do the eigen decomposition into vectors and values
```{r}
# prepare covariance matrix
NWR <-"NWR.24I.above13Mb_NoSexChr_NonMaskedRegions_GL2_unrelated.tv.cov"
mNWR <- as.matrix(read.table(NWR))

# run the eigen decomposition
eNWR <- eigen(mNWR)

# calculate the eigenvalues
evalNWR = eNWR$values/sum(eNWR$values)
```


Prepare the metadata
```{r}
mdNWR = md_unrel[md_unrel$subspecies == "cottoni", ]
```


Select PCs to plot and bind them to metadata
```{r}
# PC1 and PC2
pcsNWR <- as.data.frame(eNWR$vectors[,1:3])
colnames(pcsNWR) = c("PC1", "PC2", "PC3")

# Extract relevant columns from metadata for plotting
mini_mdNWR = as.data.frame(mdNWR %>% select(sample_name, lab_ID, time_window, country))

evecNWR <- cbind(mini_mdNWR, pcsNWR)
head(evecNWR)
```

Make a composite column for the legend
```{r}
evecNWR$window_country <- paste(evecNWR$time_window, evecNWR$country, sep = " ")
head(evecNWR)
```



Set the order of the levels in the legend
```{r}
evecNWR$window_country=factor(evecNWR$window_country, levels=c("NWRpre DRC", "NWRpre Sudan", "NWRpre Uganda", "NWRpost South Sudan", "NWRpost Sudan", "NWRpost Uganda"))
```

Visualize PCs with legend per subspecies, time window and country of origin (new column in dataframe)
```{r}
## PC1 vs PC2
nwr = ggplot(evecNWR, aes(x=PC1, y=PC2)) +
  
  # draw intercept lines
  geom_vline(xintercept=0, colour="gray", linetype = "longdash")+
  geom_hline(yintercept=0, colour="gray", linetype = "longdash")+
  
  # plot data points (2 legend alternatives)
  geom_point(aes(colour = window_country, shape = window_country), alpha=.8, size=3) + 
  
  # assign colors and shapes
  scale_colour_manual(values=c("gold3", "gold3", "gold3", "darkorange", "darkorange", "darkorange")) +
  scale_shape_manual(values=c(15, 17, 8, 15, 17, 8)) +
  
  
  # labels, titles, background, etc.
  xlab(paste0("PC1 (", round(evalNWR[1]*100, 2), "%)"))+
  ylab(paste0("PC2 (", round(evalNWR[2]*100, 2), "%)"))+
  
  theme(panel.background = element_rect(fill='white', colour='black'), axis.text.x = element_text(colour='black'), axis.text.y = element_text(colour='black'), 
        strip.background = element_rect(size=.2, colour="black", fill ="#FFA5004D"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title=element_blank(), legend.key=element_rect(fill="white", colour="white"), axis.title=element_text(size=10), legend.text=element_text(size=7), legend.key.size=unit(.4, "cm"),
        legend.box.margin=margin(-10,-10,-10,-10), plot.margin=margin(0,2,0,0)) 
  
  #guides(colour = guide_legend(order = 1), shape = guide_legend(order = 2)) 
  #+ geom_text_repel(data=evecNWR, aes(label=sample_name), segment.size=.15, size=2)

nwr
```



### SWR

Open the covariance matrices of NWR or SWR and do the eigen decomposition into vectors and values
```{r}
# prepare covariance matrix
SWR <-"SWR.25I.above13Mb_NoSexChr_NonMaskedRegions_GL2_unrelated.tv.cov"
mSWR <- as.matrix(read.table(SWR))

# run the eigen decomposition
eSWR <- eigen(mSWR)

# calculate the eigenvalues
evalSWR = eSWR$values/sum(eSWR$values)
```


Prepare the metadata
```{r}
mdSWR = md_unrel[md_unrel$subspecies == "simum", ]
```


Select PCs to plot and bind them to metadata
```{r}
# PC1 and PC2
pcsSWR <- as.data.frame(eSWR$vectors[,1:3])
colnames(pcsSWR) = c("PC1", "PC2", "PC3")

# Extract relevant columns from metadata for plotting
mini_mdSWR = as.data.frame(mdSWR %>% select(sample_name, lab_ID, time_window, country))

evecSWR <- cbind(mini_mdSWR, pcsSWR)
head(evecSWR)
```


Make a composite column for the legend
```{r}
evecSWR$window_country <- paste(evecSWR$time_window, evecSWR$country, sep = " ")
head(evecSWR)
```


Set the correct order of the levels in the legend
```{r}
evecSWR$window_country=factor(evecSWR$window_country, levels=c("SWRpre South Africa", "SWRpre Namibia", "SWRpost unknown", "SWRpost South Africa", "SWRpost captive"))
```

Visualize the PCs
```{r}
## PC1 vs PC2
swr = ggplot(evecSWR, aes(x=PC1, y=PC2)) +
  
  # draw intercept lines
  geom_vline(xintercept=0, colour="gray", linetype = "longdash")+
  geom_hline(yintercept=0, colour="gray", linetype = "longdash")+
  
  # plot data points (2 legend alternatives)
  geom_point(aes(colour = window_country, shape = window_country), alpha=.8, size=3) + 
  
  # assign colors and shapes
  scale_colour_manual(values=c("royalblue4", "royalblue4", "steelblue3", "steelblue3", "steelblue3")) +
  scale_shape_manual(values=c(16, 17, 17, 16, 8)) +
  
  # labels, titles, background, etc.
  xlab(paste0("PC1 (", round(evalSWR[1]*100, 2), "%)"))+
  ylab(paste0("PC2 (", round(evalSWR[2]*100, 2), "%)"))+
  
  theme(panel.background = element_rect(fill='white', colour='black'), axis.text.x = element_text(colour='black'), axis.text.y = element_text(colour='black'), 
        strip.background = element_rect(size=.2, colour="black", fill ="#FFA5004D"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
        legend.title=element_text(size=0), legend.key=element_rect(fill="white", colour="white"), axis.title=element_text(size=10), legend.text=element_text(size=7), legend.key.size=unit(.4, "cm"), 
        legend.box.margin=margin(-10,-10,-10,-10), plot.margin=margin(0,2,0,0)) +
  
  geom_text_repel(data=subset(evecSWR, time_window=="SWRpre"), aes(label=sample_name), segment.size=.3, segment.alpha=.8, size=2.4, force=20, box.padding=0.5, colour="gray20")
   

swr
```



### Arrange the composite figure with the PCAs of interest

Fist get the legend of the first plot with both subpescies

```{r}
# Extract the legend. Returns a gtable
leg <- get_legend(A)

# Convert to a ggplot and print
as_ggplot(leg)
```


Now arrange the per-subspecies plots in a column
```{r}
subsp = ggarrange(nwr + guides(colour=F, shape=F), swr + guides(colour=F, shape=F), nrow = 2, ncol = 1, labels=c("B", "C"))
subsp
```


Now arrange the first plot for both subspecies plus the column of per-subspecies plots
```{r}
PCAps = ggarrange(A + guides(colour=F, shape=F), subsp, nrow=1, ncol=2, labels=c("A", NULL), align = c("v"))
PCAps
```

Now add the common legend for all 3 plots
```{r}
fig = plot_grid(PCAps, leg, ncol = 1, rel_heights = c(1, .3))
fig
```



```{r}
pdf('WR_v5_Fig2_PCAs.pdf', height=6, width=8, useDingbats = F)
fig
dev.off()
```









