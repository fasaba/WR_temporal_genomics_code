---
title: "Het correlations"
author: "Fátima S. Barreiro"
date: "July 10, 2020"
output: html_document
---




Load required libraries
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(ggplot2)
library(cowplot)
library(ggrepel)
library(reshape2)
library(dplyr)
library(tidyverse)
library(data.table)
require(scales)
library(ggpubr)
library(tidyr)
library(PairedData)
library(gridExtra)
```


Reading in file containing metadata and genomic diversity metrics 
```{r}
data = read.csv("WR_TableS1_v4.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```




### Correlations between different estimates of heterozygosity

```{r}
#data$gw_het_GL2
ggplot(data, aes(uncorrected_gw_het)) + geom_histogram()
ggplot(data, aes(corrected_gw_het)) + geom_histogram()
ggplot(data, aes(gw_het_GL2)) + geom_histogram()
ggplot(data, aes(gw_het_GL2_3x)) + geom_histogram()
```


```{r}
C1 = ggscatter(data, x = "uncorrected_gw_het", y = "corrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL1 uncorrected vs GWhet with GL1 corrected")

C2 = ggscatter(data, x = "uncorrected_gw_het", y = "gw_het_GL2", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL1 uncorrected vs GWhet with GL2")

C3 = ggscatter(data, x = "corrected_gw_het", y = "gw_het_GL2", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL1 corrected vs GWhet with GL2")

C4 = ggscatter(data, x = "gw_het_GL2_3x", y = "gw_het_GL2", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL2 and 3x min VS GL2")

C5 = ggscatter(data, x = "gw_het_GL2_3x", y = "uncorrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL2 and 3x min VS GL1")

C6 = ggscatter(data, x = "gw_het_GL2_3x", y = "corrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("GWhet with GL2 and 3x min VS GL1-corrected")

```


```{r}
C4
C5
C6
```


```{r eval=FALSE, include=FALSE}
pdf("WR_Het_GLcorrelations.pdf", height=7, useDingbats = F)
plot_grid(C1, C2, C3, nrow=3, ncol=1)
dev.off
```




### Individual heterozygosity across groups


```{r}
A = ggplot(data, aes(time_window, uncorrected_gw_het)) + geom_violin(aes(colour=time_window, fill=time_window), lwd=.3, alpha=.4) + ggtitle(label="GWhet with GL1") +
  geom_jitter(colour='gray40', shape=16, position=position_jitter(0.11), cex=.6, alpha=.7) +
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=7, colour='gray10'), axis.title=element_text(size=7), 
                     panel.grid.major=(element_line(size=.12, colour='gray80'))) + 
  stat_compare_means(paired=F, method = "wilcox.test", comparisons= list(c("NWR1", "NWR2"), c("SWR1", "SWR2"))) 
#+ geom_text_repel(data=data, aes(label=sample_name), segment.size=.15, size=2)


B = ggplot(data, aes(time_window, corrected_gw_het)) + geom_violin(aes(colour=time_window, fill=time_window), lwd=.3, alpha=.4) + ggtitle(label="GWhet with GL1 corrected") +
  geom_jitter(colour='gray40', shape=16, position=position_jitter(0.11), cex=.6, alpha=.7) +
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=7, colour='gray10'), axis.title=element_text(size=7), 
                     panel.grid.major=(element_line(size=.12, colour='gray80'))) +
    stat_compare_means(paired=F, method = "wilcox.test", comparisons= list(c("NWR1", "NWR2"), c("SWR1", "SWR2"))) 
#+ geom_text_repel(data=data, aes(label=sample_name), segment.size=.15, size=2)



C = ggplot(data, aes(time_window, gw_het_GL2)) + geom_violin(aes(colour=time_window, fill=time_window), lwd=.3, alpha=.4) + ggtitle(label="GWhet with GL2") + 
  geom_jitter(colour='gray40', shape=16, position=position_jitter(0.11), cex=.6, alpha=.7) +
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=7, colour='gray10'), axis.title=element_text(size=7), 
                     panel.grid.major=(element_line(size=.12, colour='gray80'))) +
    stat_compare_means(paired=F, method = "wilcox.test", comparisons= list(c("NWR1", "NWR2"), c("SWR1", "SWR2"))) 
#+ geom_text_repel(data=data, aes(label=sample_name), segment.size=.15, size=2)




D = ggplot(data, aes(time_window, gw_het_GL2_3x)) + geom_violin(aes(colour=time_window, fill=time_window), lwd=.3, alpha=.4) + ggtitle(label="GWhet with GL2 and 3x min DoC") +
  geom_jitter(colour='gray40', shape=16, position=position_jitter(0.11), cex=.6, alpha=.7) +
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=7, colour='gray10'), axis.title=element_text(size=7), 
                     panel.grid.major=(element_line(size=.12, colour='gray80'))) +
    stat_compare_means(paired=F, method = "wilcox.test", comparisons= list(c("NWR1", "NWR2"), c("SWR1", "SWR2"))) + 
  geom_text_repel(data=data, aes(label=lab_ID), segment.size=.15, size=2)





```



```{r}
A
B
C
D
```



```{r eval=FALSE, include=FALSE}
pdf("WR_Het_GLcomparisons.pdf", height=7, useDingbats = F)
plot_grid(A, B, C, D, nrow=2, ncol=2, labels=c('A','B','C','D'))
dev.off
```




### Correlations between het and depth of coverage

```{r}
D1 = ggscatter(data, x = "depth_of_coverage", y = "uncorrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("DoC vs GWhet GL1 uncorrected")

D2 = ggscatter(data, x = "depth_of_coverage", y = "corrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("DoC vs GWhet GL1 corrected")

D3 = ggscatter(data, x = "depth_of_coverage", y = "gw_het_GL2", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("DoC vs GWhet GL2")

D4 = ggscatter(data, x = "depth_of_coverage", y = "gw_het_GL2_3x", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("DoC vs GWhet GL2-3x minDoC")


```


```{r}
D1
D2
D3
D4
```


```{r eval=FALSE, include=FALSE}
pdf("WR_HetVsDoc.pdf", height=8, width=9, useDingbats = F)
plot_grid(D1, D2, D3, D4, nrow=2, ncol=2, labels=c('A','B','C','D'))
dev.off
```


```{r}
E1 = ggscatter(data, x = "X5â..CtoT_damage", y = "uncorrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("Damage vs GWhet GL1 uncorrected")

E2 = ggscatter(data, x = "X5â..CtoT_damage", y = "corrected_gw_het", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("Damage vs GWhet GL1 corrected")

E3 = ggscatter(data, x = "X5â..CtoT_damage", y = "gw_het_GL2", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("Damage vs GWhet GL2")

E4 = ggscatter(data, x = "X5â..CtoT_damage", y = "gw_het_GL2_3x", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson") + ggtitle("Damage vs GWhet GL2-3x minDoC")


```


```{r}
E1
E2
E3
E4
```



```{r eval=FALSE, include=FALSE}
pdf("WR_HetVsDamage.pdf", height=8, width=9, useDingbats = F)
plot_grid(E1, E2, E3, E4, nrow=2, ncol=2, labels=c('A','B','C','D'))
dev.off
```




### Final plots and comparisons between temporal groups

```{r}
# plot het values per time window
gw_het = ggplot(data, aes(time_window, gw_het_GL2)) + 
  theme_bw() + theme(legend.position = "none", axis.text=element_text(size=7, colour='gray10'), axis.title.y=element_text(size=7), 
                     panel.grid.major=(element_line(size=.12, colour='gray80')))
  
  
# plot violin per group
gw_het = gw_het +  geom_violin(aes(colour=time_window, fill=time_window), lwd=.3, alpha=.4) +
  
  # add scatter points per group
  geom_jitter(colour='gray40', shape=16, position=position_jitter(0.11), cex=.6, alpha=.7) + 
  
  # add colours and filling colours
  scale_fill_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) + 
  scale_color_manual(values= (c("gold3", "darkorange", "royalblue4", "steelblue3"))) +
  
  # add stats and an unpaired wilcox test to compare the medians
  stat_summary(fun=median, geom="crossbar", colour='black', width=.12, lwd=.3) +
  
  stat_summary(fun=mean, fun.min = function (gw_het_GL2) mean(gw_het_GL2) - sd(gw_het_GL2), 
               fun.max = function(gw_het_GL2) mean(gw_het_GL2) + sd(gw_het_GL2), geom = "pointrange" , size=.12, stroke=.4, col="black") +
  
  stat_compare_means(paired=F, method = "wilcox.test", comparisons= list(c("NWR1", "NWR2"), c("SWR1", "SWR2")), label.y=c(0.00024, 0.00020), size=2.5) +
  
  # embellish
  scale_y_continuous(limits=c(0.00007, 0.00025),labels = function(x) format(x, scientific = FALSE)) +
  
  
  labs(x=NULL, y="Genome-wide heterozygosity (tv)") + geom_text_repel(data=data, aes(label=lab_ID), segment.size=.15, size=2)

gw_het
```






### GW het stats and delta estimators

Summary statistics for gw_het across the 4 groups
```{r}
# for all samples
data %>%
  group_by(time_window) %>%
  summarize(min=min(gw_het_GL2), max=max(gw_het_GL2), median=median(gw_het_GL2))

# excluding those of depth of coverage below 4x
data %>%
  subset(depth_of_coverage > 4) %>%
  group_by(time_window) %>%
  summarize(min=min(gw_het_GL2), max=max(gw_het_GL2), median=median(gw_het_GL2))
```



### Statistical comparison of gw_het median between pre- and post-bottleneck samples for each subspecies

Subsetting data per group (subspecies and time window)
```{r}
nwr1 = data[data$time_window == "NWR1",]
nwr2 = data[data$time_window == "NWR2",]
swr1 = data[data$time_window == "SWR1",]
swr2 = data[data$time_window == "SWR2",]
```


```{r}
wilcox.test(nwr1$gw_het_GL2, nwr2$gw_het_GL2, paired = F)
wilcox.test(swr1$gw_het_GL2, swr2$gw_het_GL2, paired = F)
```



Subsetting data per group excluding samples of low depth
```{r}
nwr1_f = data[data$time_window == "NWR1" & data$depth_of_coverage > 4,]
nwr2 = data[data$time_window == "NWR2",]
swr1_f = data[data$time_window == "SWR1" & data$depth_of_coverage > 4,]
swr2 = data[data$time_window == "SWR2",]
```


```{r}
wilcox.test(nwr1_f$gw_het_GL2, nwr2$gw_het_GL2, paired = F)
wilcox.test(swr1_f$gw_het_GL2, swr2$gw_het_GL2, paired = F)
```



### Downsampling test

#### Experiment 1. Medium-depth samples

Read in data table
```{r}
DSdata = read.csv("GWhet_GL2_DStest.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```


```{r}
F1 = ggplot(data=DSdata[DSdata$doc_filter == "filter",], aes(depth, het, colour=sample)) + geom_point() + geom_line() +
  ylim(limits=c(0,6e-4)) + ggtitle("Downsampling test with a 3x minimum depth per site") +
  xlim(limits=c(0,23))

F2 = ggplot(data=DSdata[DSdata$doc_filter == "no_filter",], aes(depth, het, colour=sample)) + geom_point() + geom_line() +
  ylim(limits=c(0,6e-4)) + ggtitle("Downsampling test without filtering depth per site ") +
  xlim(limits=c(0,23))

F1
F2

```


```{r}
pdf("WR_GWhet_DStest.pdf", useDingbats = F)
plot_grid(F1, F2, nrow=2, ncol=1)
dev.off
```




```{r}
ggplot(DSdata, aes(depth, proportion_het, colour=sample)) + geom_point() + geom_line(aes(linetype=doc_filter))
```




```{r}
P = ggplot(DSdata, aes(sample, proportion_het, fill=doc_filter)) + geom_boxplot() + ggtitle("Distribution of the proportions of the original heterozygosity in downsampled sfs'")

P

```

```{r}
pdf("WR_GWhet_DStest_prop.pdf", useDingbats = F)
P
dev.off
```




#### Experiment 2. High-depth samples

Read in data table
```{r}
DSdata2 = read.csv("GWhet_GL2_DSexperiment2.csv", h=T, fill=T, stringsAsFactors=T, fileEncoding="latin1")
```


How does het change with decreasing depth of coverage for a given sample?

```{r}
F3 = ggplot(data=DSdata2[DSdata2$doc_filter == "ds" | DSdata2$doc_filter == "original" ,], aes(depth, het, colour=sample)) + geom_point() + geom_line() +
  ylim(limits=c(0,6e-4)) + ggtitle("Downsampling test with a 3x minimum depth per site") +
  xlim(limits=c(0,23))

F4 = ggplot(data=DSdata2[DSdata2$doc_filter == "noFilter_ds" | DSdata2$doc_filter == "original",], aes(depth, het, colour=sample)) + geom_point() + geom_line() +
  ylim(limits=c(0,6e-4)) + ggtitle("Downsampling test without filtering depth per site ") +
  xlim(limits=c(0,23))

F3
F4

```




Taking the het at the original depth as a reference, here are the differences that the het estimates at decreasing depths show

```{r}
ggplot(DSdata2, aes(depth, diff, colour=sample)) + geom_point() + geom_line(aes(linetype=doc_filter))
```

At depths <5x, filtering out sites with depth below 3x improves the het estimates.



### Extracting some plots to compare

Het along the depths of the DS experiments for medium depth and high depth samples
```{r}
pdf("WR_GWhet_DStest_lowhighsamples.pdf", useDingbats = F)
plot_grid(F1, F3, nrow=2, ncol=1)
dev.off
```























